<div *ngIf="loading; else profileContent" class="loading-screen">
  <div class="loader"></div>
  <p>Loading your profile…</p>
</div>

<ng-template #profileContent>
  <div class="profile-layout">

    <aside class="sidebar">
      <button class="back" (click)="back()">← Back to home</button>

      <h3>My Space</h3>

      <button (click)="setSection('dashboard')">Dashboard</button>
      <button (click)="setSection('history')">My History</button>
      <button (click)="setSection('account')">Account details</button>
      <button class="danger" (click)="setSection('delete')">Delete account</button>

      <button class="logout" (click)="logout()">Logout</button>
    </aside>

    <main class="content">

      <section *ngIf="activeSection == 'dashboard'">
        <div class="dashboard-header">
          <h2>Dashboard</h2>
          <button class="mood-button" (click)="goToMoodCheckIn()">Mood Check-in</button>
        </div>
        <p>Welcome back {{ user.firstName }}</p>

        <div class="metrics-grid">

          <div class="metric-card">
            <h3>Mental health</h3>
            <div class="metric-value"
                [style.color]="getMetricColor(user.mental)">
              {{ user.mental }}/10
            </div>
            <div class="metric-bar">
              <div class="metric-fill"
                  [style.width.%]="user.mental * 10"
                  [style.background]="getMetricColor(user.mental)">
              </div>
            </div>
          </div>

          <div class="metric-card">
            <h3>Sleep quality</h3>
            <div class="metric-value"
                [style.color]="getMetricColor(user.sleep)">
              {{ user.sleep }}/10
            </div>
            <div class="metric-bar">
              <div class="metric-fill"
                  [style.width.%]="user.sleep * 10"
                  [style.background]="getMetricColor(user.sleep)">
              </div>
            </div>
          </div>

          <div class="metric-card">
            <h3>Stress level</h3>

            <div class="metric-value"
                [style.color]="getStressColor(user.stress)">
              {{ user.stress }}/10
            </div>

            <div class="metric-bar">
              <div class="metric-fill"
                  [style.width.%]="user.stress * 10"
                  [style.background]="getStressColor(user.stress)">
              </div>
            </div>
          </div>

          <div class="metric-card">
            <h3>Meditation experience</h3>
            <div class="metric-value"
                [style.color]="getMetricColor(user.meditation)">
              {{ user.meditation }}/10
            </div>
            <div class="metric-bar">
              <div class="metric-fill"
                  [style.width.%]="user.meditation * 10"
                  [style.background]="getMetricColor(user.meditation)">
              </div>
            </div>
          </div>

        </div>
      </section>

      <section *ngIf="activeSection == 'history'">
        <h2>Viewing History</h2>
        
        <div *ngIf="historyLoading && userHistory.length === 0" class="small-loader">Loading history...</div>

        <div *ngIf="!historyLoading && userHistory.length === 0" class="empty-state">
          <p>You haven't watched any sessions yet.</p>
        </div>

        <div class="history-list" *ngIf="userHistory.length > 0">
          
          <div class="history-item" *ngFor="let item of userHistory">
            <div class="history-info">
              <span class="video-name">
                {{ videoCatalogue.get(item.videoId) || 'Loading title...' }}
              </span>
              <span class="history-date">{{ item.updatedAt | date:'medium' }}</span>
            </div>
            
            <div class="history-details">
              <span class="history-rating">
                <ng-container *ngFor="let type of getStarsArray(item.rating)">
                  <i class="star-icon" [ngClass]="type">
                    {{ type === 'half' ? '⯪' : '★' }}
                  </i>
                </ng-container>
                <span class="rating-text" *ngIf="item.rating">({{ item.rating / 2 }}/5)</span>
              </span>
              <span class="history-progress">Watched: {{ item.watchedDuration }}s</span>
            </div>

            <div class="history-comments" *ngIf="item.comments && item.comments.length > 0">
              <p class="comment-preview" *ngFor="let comm of item.comments">
                "{{ comm.text }}" <small>({{ comm.postedAt | date:'shortDate' }})</small>
              </p>
            </div>
          </div>

          <div class="load-more-container" *ngIf="!isLastPage">
            <button class="load-more-btn" (click)="loadMore()" [disabled]="historyLoading">
              {{ historyLoading ? 'Loading more...' : 'Show older sessions' }}
            </button>
          </div>

          <p class="end-of-list" *ngIf="isLastPage && userHistory.length > 0">
            You've reached the end of your history.
          </p>

        </div>
      </section>

      <section *ngIf="activeSection == 'account'">
        <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>
        <div *ngIf="successMessage" class="success-message">{{ successMessage }}</div>
        <div class="header-row">
          <h2>Account details</h2>
          <button (click)="toggleEdit()">
            {{ isEditing ? 'Save' : 'Edit' }}
          </button>
        </div>

        <form class="form-grid">
          <div class="form-group">
            <label>First name</label>
            <input [(ngModel)]="editableUser.firstName"
                  name="firstName"
                  [disabled]="!isEditing">
          </div>

          <div class="form-group">
            <label>Last name</label>
            <input [(ngModel)]="editableUser.lastName"
                  name="lastName"
                  [disabled]="!isEditing">
          </div>

          <div class="form-group">
            <label>Email</label>
            <input
              [(ngModel)]="editableUser.email"
              name="email"
              disabled>
          </div>

          <div class="form-group">
          <label>Country</label>
            <select [(ngModel)]="editableUser.locale" name="country" [disabled]="!isEditing">
              <option *ngFor="let country of countries" [value]="country">{{ country }}</option>
            </select>
          </div>

          <div class="form-group">
            <label>City</label>
            <input [(ngModel)]="editableUser.city"
                  name="city"
                  [disabled]="!isEditing">
          </div>

          <div class="form-group">
            <label>Notifications</label>
            <select [(ngModel)]="editableUser.preferences" name="notifications" [disabled]="!isEditing">
              <option *ngFor="let option of notificationsOptions" [value]="option">{{ option }}</option>
            </select>
          </div>
        </form>
      </section>

      <section *ngIf="activeSection == 'delete'">
        <div *ngIf="errorMessage" class="error-message">{{ errorMessage }}</div>
        <div *ngIf="successMessage" class="success-message">{{ successMessage }}</div>
        <h2>Delete account</h2>
        <p>This action is irreversible.</p>
        <form (ngSubmit)="submitDeleteAccount()">
          <div class="form-grid-vertical">
            <div class="form-group">
              <label>Type "I want to delete my account."</label>
              <input type="text" [(ngModel)]="confirmationText" name="confirmationText" required>
            </div>
            <div class="form-group">
              <button class="danger" type="submit">Delete my account</button>
            </div>
          </div>
        </form>
      </section>

    </main>

  </div>
</ng-template>